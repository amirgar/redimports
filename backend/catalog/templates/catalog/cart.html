{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Red Imports Store - Корзина</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="{% static 'catalog/css/style.css' %}?v=5.2">

    <style>
        /* --- БАЗОВЫЙ СЛОЙ --- */
        body {
            background-color: #F9F9F9;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #eee;
        }
        
        .header .back-link {
            text-decoration: none;
            color: #000;
            font-size: 18px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* --- КАРТОЧКА С РОБОЧИМ СВАЙПОМ --- */
        .product-cardd {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scrollbar-width: none; 
            -ms-overflow-style: none;
            background: transparent;
            margin-bottom: 12px;
            /* Разрешаем вертикальный скролл страницы */
            touch-action: pan-y; 
        }

        .product-cardd::-webkit-scrollbar { display: none; }

        .card-main-content {
            flex: 0 0 100%;
            width: 100%;
            background: #fff;
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            gap: 15px;
            scroll-snap-align: start;
            /* Внутри карточки тоже разрешаем свайп вверх/вниз */
            touch-action: pan-y;
        }

        .delete-action-btn {
            flex: 0 0 80px;
            background-color: #FF3B30;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: end;
            border: none;
            cursor: pointer;
        }

        /* Анимация схлопывания при удалении */
        .card-collapsing {
            transition: all 0.3s ease;
            max-height: 0 !important;
            margin-bottom: 0 !important;
            opacity: 0 !important;
            overflow: hidden !important;
        }

        /* --- ВНУТРЕННИЕ ЭЛЕМЕНТЫ --- */
        .img-wrapper {
            width: 90px; height: 90px;
            background-color: #F2F2F2;
            border-radius: 8px;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .img-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; mix-blend-mode: multiply; }

        .info { flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .top-row { display: flex; justify-content: space-between; }
        .price { font-weight: 600; font-size: 16px; font-family: T2-Reg; }
        .checkbox-custom { width: 20px; height: 20px; accent-color: #000; }
        
        .brand { font-size: 12px; color: #888; text-transform: uppercase; font-family: T2-Reg; }
        .name { font-size: 14px; margin: 0; line-height: 1.2; font-family: T2-Reg; }
        .meta { font-size: 12px; color: #888; font-family: T2-Reg; }

        .controls {
            display: flex; align-items: center; background: #F2F2F2;
            border-radius: 6px; width: fit-content; padding: 2px;
        }
        .controls button { background: none; border: none; width: 30px; height: 24px; cursor: pointer; }
        .controls span { font-size: 14px; min-width: 20px; text-align: center; font-family: T2-Reg; }

        /* --- ИТОГИ И КНОПКА --- */
        .total-block { background: #fff; padding: 20px; margin-top: 10px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-family: T2-Reg; font-size: 14px; }
        .final { border-top: 1px solid #eee; padding-top: 15px; font-size: 18px; font-weight: bold; }
        .pink-text { color: #FF3B30; }

        .submit-btn {
            background-color: #FF3B30; color: white; width: 100%; border: none;
            padding: 15px 20px; font-size: 16px; font-weight: 600;
            position: fixed; bottom: 0; left: 0;
            display: flex; justify-content: space-between;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            z-index: 101;
        }

        .cart-content { padding-bottom: 120px; }
    </style>
</head>
<body>

<div class="cart-page">
    <header class="header">
        <a href="javascript:history.back()" class="back-link">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            корзина
        </a>
    </header>

    {% if cart.items.exists %}
        <div class="cart-content">
            <div style="padding: 15px 20px; color: #888; font-size: 14px;">
                Количество товаров: {{ cart.items.count }}
            </div>

            {% for item in cart.items.all %}
            <div class="product-cardd" id="card-{{ item.id }}">
                <div class="card-main-content">
                    <div class="img-wrapper">
                        {% if item.product.images.exists %}
                            <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.name }}">
                        {% else %}
                            <img src="{% static 'catalog/img/no-image.png' %}" alt="No image">
                        {% endif %}
                    </div>
                    
                    <div class="info">
                        <div class="top-row">
                            <span class="price">{% if item.product.discount_price %}{{ item.product.discount_price }}{% else %}{{ item.product.price }}{% endif %} ₽</span>
                            <input type="checkbox" class="checkbox-custom" checked>
                        </div>
                        <div>
                            <p class="brand">{{ item.product.brand.name }}</p>
                            <p class="name">{{ item.product.name }}</p>
                            <p class="meta">{{ item.selected_params|default:"RUS 35 белый" }}</p>
                        </div>
                        <div class="controls">
                            <button class="js-update-cart" data-url="{% url 'update_cart' item.id 'minus' %}">−</button>
                            <span id="qty-{{ item.id }}">{{ item.quantity }}</span>
                            <button class="js-update-cart" data-url="{% url 'update_cart' item.id 'plus' %}">+</button>
                        </div>
                    </div>
                </div>

                <button class="delete-action-btn" onclick="removeItem(this, '{{ item.id }}', '{% url 'remove_from_cart' item.id %}')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
            {% endfor %}

            <div class="total-block">
                <h3>сумма заказа</h3>
                <div class="row"><span>{{ cart.items.count }} товаров</span><span>{{ cart.total_base_price }} ₽</span></div>
                <div class="row"><span>доставка</span><span>1 000 ₽</span></div>
                {% if cart.total_discount > 0 %}
                <div class="row pink-text"><span>скидка</span><span>-{{ cart.total_discount }} ₽</span></div>
                {% endif %}
                <div class="row final"><strong>итого</strong><strong>{{ cart.total_final_price }} ₽</strong></div>
            </div>
        </div>

        <button class="submit-btn" onclick="location.href='#'">
            <span style="font-family: T2-Reg;">оформить</span>
            <span style="font-family: T2-Reg;">{{ cart.total_final_price }} ₽</span>
        </button>
    {% else %}
        <div class="empty-state">
            <h1>ТУТ ПОКА ПУСТО</h1>
            <p>для выбора товаров<br>перейдите в <a href="{% url 'catalog' %}">каталог</a></p>
        </div>
    {% endif %}
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

// Обновление количества
document.querySelectorAll('.js-update-cart').forEach(btn => {
    btn.onclick = function() {
        fetch(this.dataset.url).then(() => location.reload());
    };
});

// ПРАВИЛЬНОЕ УДАЛЕНИЕ
function removeItem(btn, itemId, url) {
    const card = document.getElementById('card-' + itemId);
    
    // 1. Убираем магнит (snap), чтобы он не мешал анимации
    card.style.scrollSnapType = 'none';
    
    // 2. Анимируем уезд карточки влево до упора
    card.scrollTo({
        left: card.scrollWidth,
        behavior: 'smooth'
    });

    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');

    // 3. Через 300мс схлопываем высоту и удаляем
    setTimeout(() => {
        card.classList.add('card-collapsing');
        
        setTimeout(() => {
            fetch(url).then(() => location.reload());
        }, 300);
    }, 200);
}

// Фикс: всегда сбрасываем скролл карточек влево при старте
window.onload = () => {
    document.querySelectorAll('.product-cardd').forEach(c => c.scrollLeft = 0);
};
</script>
</body>
</html>