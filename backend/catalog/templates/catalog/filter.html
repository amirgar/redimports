{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Red Imports Store</title>
    <link rel="stylesheet" href="{% static 'catalog/css/style.css' %}?v=5.1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .price-input {
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            padding: 8px 12px;
            width: 80px;
            font-size: 16px;
            background: #F9F9F9;
            text-align: center;
        }
        .price-input:focus {
            outline: none;
            border-color: #000;
            background: #FFF;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

    </style>
</head>
<body>
<div class="app-container">
<main class="scrollable-content" style="padding-bottom: 90px;">
    <br><br>
    <div class="header-content" style="padding-left: 120px; padding-top: 10px; padding-bottom: 10px;">
        <img src="{% static 'catalog/img/logo_red.svg' %}" class="header-logo-img">
        <span class="header-logo-text">red imports</span>
    </div>
    
    <div class="filters-page">
        <header class="filters-header">
            <button class="back-btn" onclick="window.history.back()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M15 18L9 12L15 6" stroke="black" stroke-width="2"
                          stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h1 class="filters-title">фильтры</h1>
            <a href="{% url 'filter' category.id %}" class="reset-btn">сбросить</a>
        </header>

        <div class="filters-content">
            
            <div class="filter-section price-section">
                <div class="price-inputs">
                    <div class="price-field">
                        <span>от</span> 
                        <input 
                            type="number" 
                            id="price-min" 
                            class="price-input" 
                            placeholder="{{ min_price }}" 
                            value="{{ request.GET.min_price|default:'' }}"
                            style="outline: none; border: none; background-color: #F2F2F7; width: 120px;"
                        > 
                        ₽
                    </div>
                    <div class="price-field">
                        <span>до</span> 
                        <input 
                            type="number" 
                            id="price-max" 
                            class="price-input" 
                            placeholder="{{ max_price }}" 
                            value="{{ request.GET.max_price|default:'' }}"
                            style="outline: none; border: none; background-color: #F2F2F7; width: 120px;"
                        > 
                        ₽
                    </div>
                </div>
            </div>

            <div class="filter-row">
                <span>скидки</span>
                <label class="switch">
                    <input
                        type="checkbox"
                        data-key="discount"
                        data-value="1"
                        {% if request.GET.discount %}checked{% endif %}
                    >
                    <span class="slider"></span>
                </label>
            </div>

            <div class="chips-section">
                <h3>бренды</h3>
                <div class="chips-grid">
                    {% for brand in brands %}
                        <button
                            class="chip {% if brand.id|stringformat:'s' in selected_brands %}active{% endif %}"
                            data-key="brand"
                            data-value="{{ brand.id }}"
                            type="button"
                            style="color: #000;"
                        >
                            {{ brand.name }}
                        </button>
                    {% endfor %}
                </div>
            </div>

            {% if sizes %}
            <div class="chips-section">
                <h3>размер</h3>
                <div class="chips-grid size-grid">
                    {% for size in sizes %}
                        <button
                            class="chip"
                            data-key="sizes"
                            data-value="{{ size }}"
                            type="button"
                            style="color: #000;"
                        >
                            {{ size }}
                        </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% for param, values in filters.items %}
            <div class="chips-section">
                <h3>{{ param }}</h3>
                <div class="chips-grid">
                    {% for value in values %}
                        <button
                            class="chip"
                            style="color: #000;"
                            data-key="{{ param }}"
                            data-value="{{ value }}"
                            type="button"
                        >
                            {{ value }}
                        </button>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

        </div>
    </div>
</main>
</div>

<footer class="filters-footer">
    <button class="apply-btn" id="applyFilters">
        показать товары
    </button>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);

    // 1. Инициализация кнопок (CHIPS)
    document.querySelectorAll('.chip').forEach(btn => {
        const key = btn.dataset.key;
        const value = btn.dataset.value;
        if (!key || !value) return;

        const currentValues = params.getAll(key);
        if (currentValues.includes(value)) {
            btn.classList.add('active');
        }

        btn.addEventListener('click', () => {
            btn.classList.toggle('active');
            let values = params.getAll(key);
            if (btn.classList.contains('active')) {
                if (!values.includes(value)) values.push(value);
            } else {
                values = values.filter(v => v !== value);
            }
            params.delete(key);
            values.forEach(v => params.append(key, v));
        });
    });

    // 2. Переключатель СКИДКИ
    document.querySelectorAll('input[type="checkbox"][data-key]').forEach(input => {
        const key = input.dataset.key;
        const value = input.dataset.value;
        if (params.get(key) === value) input.checked = true;

        input.addEventListener('change', () => {
            if (input.checked) {
                params.set(key, value);
            } else {
                params.delete(key);
            }
        });
    });

    // 3. Кнопка ПРИМЕНИТЬ
    document.getElementById('applyFilters').addEventListener('click', () => {
        const minPriceInput = document.getElementById('price-min');
        const maxPriceInput = document.getElementById('price-max');

        if (minPriceInput && minPriceInput.value) {
            params.set('min_price', minPriceInput.value);
        } else {
            params.delete('min_price');
        }

        if (maxPriceInput && maxPriceInput.value) {
            params.set('max_price', maxPriceInput.value);
        } else {
            params.delete('max_price');
        }

        params.delete('v'); // Очистка мусора

        const categoryId = "{{ category.id }}";
        const query = params.toString();
        window.location.href = `/category/${categoryId}/?${query}`;
    });
});
</script>
</body>
</html>