{% load static %}
{% load static ru_plural %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Red Imports Store</title>
    <link rel="stylesheet" href="{% static 'catalog/css/style.css' %}?v=5.1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="app-container">
        <br>
        <br>
        <div class="header-content" style="padding-left: 135px; padding-top: 10px; padding-bottom: 10px;">
            <img src="{% static 'catalog/img/logo_red.svg' %}" class="header-logo-img">
            <span class="header-logo-text">red imports</span>
        </div>
        <main class="scrollable-content" style="padding-bottom: 90px;"> <div class="category-header">
                <div class="category-header">
                    <div class="ch-top-row">
                        <button class="back-btn" onclick="window.history.back()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M15 18L9 12L15 6" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                        <h1 class="ch-title" style="font-weight: 400;">{{ category.name }}</h1>
                    </div>
                    
                    <div class="ch-bottom-row">
                        <span class="product-count">
                            {{ products.count }} {{ products.count|ru_plural:"продукт,продукта,продуктов" }}
                        </span>
                        
                        <div class="filter-controls">
                            <div class="filter-count-square">2</div>
                            
                            <button class="filter-settings-btn">
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <br>

    <div class="products-grid">
        {% for product in products %}
        <div class="product-card" data-url="{{ product.get_absolute_url }}">
            <div class="product-image-container">
                {% if product.is_new %}
                    <span class="badge-new">NEW</span>
                {% endif %}

                {% for image in product.images.all %}
                    {% if forloop.first %}
                        <img src="{{ image.image.url }}" class="product-img active" draggable="false">
                    {% else %}
                        <img src="{{ image.image.url }}" class="product-img" draggable="false">
                    {% endif %}
                {% endfor %}
            </div>

            <div class="product-info">
                <div class="price-row">
                    {% if product.discount_price %}
                        <span class="old-price">{{ product.discount_price }} ₽</span>
                        <span class="current-price">{{ product.price }} ₽</span>
                    {% else %}
                        <span class="current-price black">{{ product.price }} ₽</span>
                    {% endif %}
                </div>

                <h3 class="brand-name">{{ product.brand.name }}</h3>
                <p class="product-description">{{ product.name }}</p>
            </div>
        </div>
        {% empty %}
        <p>В этой категории пока нет товаров</p>
        {% endfor %}
    </div>
            </div>

        </main>
        <footer class="bottom-fixed-container">
        <div class="promo-strip">Скидка до -25% по промокоду WINTERMOVV</div>
        <nav class="nav-bar">
            <div class="nav-item"><a href="{% url 'catalog' %}"><img src="{% static 'catalog/img/menu_icon.svg' %}" width="32"></a></div>
            <div class="nav-item"><img src="{% static 'catalog/img/heart_icon.svg' %}" width="32"></div>
            <div class="nav-item logo-box">
                    <a href="{% url 'home' %}">
                        <img src="{% static 'catalog/img/logo_red.svg' %}" width="28">
                    </a>
                </div>

            <div class="nav-item"><img src="{% static 'catalog/img/profile_icon.svg' %}" width="32"></div>
            <div class="nav-item"><img src="{% static 'catalog/img/cart_icon.svg' %}" width="32"></div>
        </nav>
    </footer>
    </div>
</body>

<script>
        
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Инициализация Telegram
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.disableVerticalSwipes();
        tg.setHeaderColor('#F2F2F2');
        tg.setBackgroundColor('#F2F2F2');

        // 2. Элементы интерфейса
        const header = document.querySelector('.custom-header');
        const scrollableContent = document.querySelector('.scrollable-content');
        const searchContainer = document.querySelector('.sticky-search-container');

        // 3. Обработка скролла (Поиск и Шапка)
        if (scrollableContent && searchContainer && header) {
            scrollableContent.addEventListener('scroll', () => {
                const scrollTop = scrollableContent.scrollTop;
                
                if (scrollTop > 50) {
                    header.classList.add('header-hidden');
                    searchContainer.classList.add('is-stuck');
                    // Устанавливаем фон через JS как запасной вариант, 
                    // но лучше оставить это в CSS классе .is-stuck
                    searchContainer.style.backgroundColor = "rgba(242, 242, 242, 0.85)";
                } else {
                    header.classList.remove('header-hidden');
                    searchContainer.classList.remove('is-stuck');
                    searchContainer.style.backgroundColor = "transparent";
                }
            }, { passive: true });
        }

        scrollableContent.addEventListener('scroll', () => {
            // Получаем расстояние от поиска до верха экрана
            const searchRect = searchContainer.getBoundingClientRect();
            
            // searchRect.top <= 0 означает, что элемент коснулся верха или ушел выше
            // Мы берем 10px для более плавного срабатывания на мобильных
            if (searchRect.top <= 10) {
                header.classList.add('header-hidden');
                searchContainer.classList.add('is-stuck');
            } else {
                // Пока поиск не доехал до верха, возвращаем всё как было
                header.classList.remove('header-hidden');
                searchContainer.classList.remove('is-stuck');
            }
        }, { passive: true });

        // 4. Свайп картинок товаров
        document.querySelectorAll('.product-image-container').forEach(container => {
            const images = Array.from(container.querySelectorAll('.product-img'));
            const dots = Array.from(container.querySelectorAll('.dot'));

            if (images.length <= 1) return;

            let index = 0;
            let startX = 0;

            container.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
            }, { passive: true });

            container.addEventListener('touchend', e => {
                const endX = e.changedTouches[0].clientX;
                const diff = startX - endX;

                if (Math.abs(diff) < 40) return;

                images[index].classList.remove('active');
                dots[index]?.classList.remove('active');

                if (diff > 0) {
                    index = (index + 1) % images.length;
                } else {
                    index = (index - 1 + images.length) % images.length;
                }

                images[index].classList.add('active');
                dots[index]?.classList.add('active');
            });
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.product-card').forEach(card => {
            card.addEventListener('click', () => {
                const url = card.dataset.url; // читаем data-url
                if (url) {
                    window.location.href = url; // переходим
                }
            });
        });
    });

    </script>
