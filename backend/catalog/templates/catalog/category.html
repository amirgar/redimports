{% load static %}
{% load static ru_plural %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Red Imports Store</title>
    <link rel="stylesheet" href="{% static 'catalog/css/style.css' %}?v=5.1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="app-container">
        <br>
        <br>
        <div class="header-content" style="padding-left: 135px; padding-top: 10px; padding-bottom: 10px;">
            <img src="{% static 'catalog/img/logo_red.svg' %}" class="header-logo-img">
            <span class="header-logo-text">red imports</span>
        </div>
        <main class="scrollable-content" style="padding-bottom: 90px;"> <div class="category-header">
                <div class="category-header">
                    <div class="ch-top-row">
                        <button class="back-btn" onclick="window.history.back()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M15 18L9 12L15 6" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                        <h1 class="ch-title" style="font-weight: 400;">{{ category.name }}</h1>
                    </div>
                    
                    <div class="ch-bottom-row">
                        <span class="product-count">
                            {{ products.count }} {{ products.count|ru_plural:"продукт,продукта,продуктов" }}
                        </span>
                        
                        <div class="filter-controls">
                            <a href="{% url 'filter' category.id %}" style="padding-left: 30px;">
                                <button class="filter-settings-btn">
                                </button>
                            </a>    
                        </div>
                    </div>
                </div>
            </div>
            <br>

    <div class="products-grid">
        {% for product in products %}
        <div class="product-card" data-url="{{ product.get_absolute_url }}">
            <div class="product-image-container">
                {% if product.is_new %}
                    <span class="badge-new">NEW</span>
                {% endif %}

                {% for image in product.images.all %}
                    {% if forloop.first %}
                        <img src="{{ image.image.url }}" class="product-img active" draggable="false">
                    {% else %}
                        <img src="{{ image.image.url }}" class="product-img" draggable="false">
                    {% endif %}
                {% endfor %}
            </div>

            <div class="product-info">
                <div class="price-row">
                    {% if product.discount_price %}
                        <span class="old-price">{{ product.price }} ₽</span>
                        <span class="current-price">{{ product.discount_price }} ₽</span>
                    {% else %}
                        <span class="current-price black">{{ product.price }} ₽</span>
                    {% endif %}
                </div>

                <h3 class="brand-name">{{ product.brand.name }}</h3>
                <p class="product-description">{{ product.name }}</p>
            </div>
        </div>
        {% empty %}
        <p>В этой категории пока нет товаров</p>
        {% endfor %}
    </div>
            </div>

        </main>
        <footer class="bottom-fixed-container">
        <div class="promo-strip">Скидка до -25% по промокоду WINTERMOVV</div>
        <nav class="nav-bar">
            <div class="nav-item"><a href="{% url 'catalog' %}"><img src="{% static 'catalog/img/menu_icon.svg' %}" width="32"></a></div>
            <div class="nav-item"><img src="{% static 'catalog/img/heart_icon.svg' %}" width="32"></div>
            <div class="nav-item logo-box">
                    <a href="{% url 'home' %}">
                        <img src="{% static 'catalog/img/logo_red.svg' %}" width="28">
                    </a>
                </div>

            <div class="nav-item"><img src="{% static 'catalog/img/profile_icon.svg' %}" width="32"></div>
            <div class="nav-item"><img src="{% static 'catalog/img/cart_icon.svg' %}" width="32"></div>
        </nav>
    </footer>
    </div>
</body>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. КЛИКИ ПО КАРТОЧКАМ (Самое важное)
    const productCards = document.querySelectorAll('.product-card');
    productCards.forEach(card => {
        card.addEventListener('click', function(e) {
            // Если кликнули по кнопке внутри (если она будет), не переходим
            if (e.target.closest('button')) return;
            
            const url = this.getAttribute('data-url');
            if (url) {
                window.location.href = url;
            }
        });
    });

    // 2. БЕЗОПАСНАЯ РАБОТА С ФИЛЬТРАМИ (только если элементы есть на странице)
    const params = new URLSearchParams(window.location.search);

    // Чипсы (если они вдруг есть в шапке)
    document.querySelectorAll('.chip').forEach(btn => {
        const key = btn.dataset.key;
        const value = btn.dataset.value;
        if (params.getAll(key).includes(value)) btn.classList.add('active');

        btn.addEventListener('click', () => {
            btn.classList.toggle('active');
            let values = params.getAll(key);
            if (btn.classList.contains('active')) {
                values.push(value);
            } else {
                values = values.filter(v => v !== value);
            }
            params.delete(key);
            values.forEach(v => params.append(key, v));
        });
    });

    // Кнопка "Применить" (она обычно на другой странице, поэтому проверяем if)
    const applyBtn = document.getElementById('applyFilters');
    if (applyBtn) {
        applyBtn.addEventListener('click', () => {
            const minPrice = document.getElementById('price-min')?.value;
            const maxPrice = document.getElementById('price-max')?.value;
            if (minPrice) params.set('min_price', minPrice);
            if (maxPrice) params.set('max_price', maxPrice);
            
            const categoryId = "{{ category.id }}";
            window.location.href = `/category/${categoryId}/?${params.toString()}`;
        });
    }
});
</script>